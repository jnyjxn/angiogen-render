\documentclass[12pt]{report}

\input{./inclure.tex}

\pagestyle{fancy}
\fancyhead[L]{}
\fancyhead[R]{}
\fancyfoot[L]{}
\fancyfoot[R]{}


\begin{document}

\newlength{\larg}
\setlength{\larg}{14.5cm}
\lstset{inputencoding=utf8/latin1}
\title{
{\rule{\larg}{1mm}}\vspace{7mm}
\begin{tabular}{p{0cm} c}
   & { {\textbf{Tutorial}}} \\
   & {\huge Use anatomical mesh classes.} \\
\end{tabular}\\
\vspace{2mm}
{\rule{\larg}{1mm}}
\vspace{2mm} \\
\begin{tabular}{p{11cm} r}
   & {\large  25/08/2016}
\end{tabular}\\
\vspace{2cm}
\large{\textit{} \\
BANGOR UNIVERSITY\\
School of Computer Science}
\vspace{5cm}
}
\author{\begin{tabular}{p{13.7cm} r}
Andr√©as MEULEMAN
\end{tabular}\\
\hline }
\date{}
\maketitle

\chapter{Introduction}

	The complete source code of this tutorial is available on the Subversion (SVN) repository at $tutorials/tutorial\_04\_qt4$. 
	
	$AnatomicalMesh$ is a virtual class inheriting from PolygonMesh\footnote{Class diagram in annexe.}. It was made to hadle meshes for different tussies. Five classes are inheriting from $AnatomicalMesh$: $SkinMesh$, $LungsMesh$, $LiverMesh$, $DiaphragmMesh$ and $BoneMesh$. They are all implementing the following public functions: \\ 

\begin{lstlisting}
	/// return true if the mesh has to be displayed with transparency
	bool isTransparent() const;

	/// return true if the mesh represent a soft tissue
	bool isSoftTissue() const;

	/// Link the attributes to their id in the shader
    	/// shader_id: The GLSL shader used to display the anatomical mesh
	void defineDisplayShaderInput(int shader_id);

	/// initialize the shaders, the buffers, the normal vectors and the textures
	void initialize();
\end{lstlisting}
~\\

	$SkinMesh$ is transparent and white by default.The other classes generate suitable textures and normal maps. They are procedural generated using noise so that they are slightly different after each launch of the program. These classes are supposed to be used with the shaders $display\_realistic\_gl3.vert$ and $display\_realistic\_gl3.frag$. 

	To use these classes, we need to set the data (vertices position and normal vectors) as we do for any PolygonMesh and then, call $defineDisplayShaderInput(int$ $shader\_id)$ just before the polygonMesh's function $display()$. In this tutorial, we will display lungs without lighting.
	
\newpage

	Here is an example of rendering using some of these classes: \\
	
\includegraphics[scale = 0.6]{img/AllMeshes.png}


\chapter{includes}

These are to use the shaders $display\_realistic\_gl3.vert$ and $display\_realistic\_gl3.frag$:
\begin{lstlisting}
#include "display_realistic_gl3.frag.h"
#include "display_realistic_gl3.vert.h"

#ifndef GVXR_MATRIX4X4_H
#include "gVirtualXRay/Matrix4x4.h"
#endif

#ifndef GVXR_SHADER_H
#include "gVirtualXRay/Shader.h"
#endif
\end{lstlisting}

We have to include the header of the class we are going to use:
\begin{lstlisting}
#include "gVirtualXRay/LungsMesh.h"
\end{lstlisting}

\chapter{Build the objects}

	the constructor of all the classes inherating from $InternalOrganMesh$ ($LungsMesh$, $LiverMesh$, $DiaphragmMesh$ and $BoneMesh$) have parameters to control the texture generation. 
	
	$LungsMesh$, $LiverMesh$ and $DiaphragmMesh$ use 2D texturing. $texture\_2D\_size$ represent the size in pixels of the side of the 2D textures used for this mesh. Its default value is 2048 for the lungs and the diaphragm and 512 for the liver but it can be modified depending on the graphic card's amount of vram.
	
	These constructors have a $bool$ parameter $optimize_texture_coordinates$. If it is true, the 2D texture coordinates will be optimize before the rendering. Optimize the texture coordinates enable a better rendering with the same performances, but it requires more precomputating. Its default value is true. \\
	
	$BoneMesh$, $LiverMesh$ and $LungsMesh$ use 3D texturing, the $unsigned$ $int$ parameter $texture\_3D\_size$ of their constructors is the size of the side of the 3D texture. Its default value is $32$, 3D textures have to be small since they use a lot of vram.
		
	The constructor of $LungsMesh$ has three other parameters of type $bool$: $x\_mirror$, $y\_mirror$ and $z\_mirror$. They enable to know if the mesh is upside down to draw the lines correctly. Their default value is false.

	The constructor of $SkinMesh$ has no parameters.

\chapter{Load the data}

To load the vertices data of the anatomical mesh, we can use any of the techniques for polygon meshes shown in the previous tutorials. When a textured anatomical mesh is used, the index of the mesh is remove before generating the textures.

	We have to be carefull with that if the data loaded involve indices and make sure that the index isn't built again. In case the index is built again, the index can be removed again by calling the function $initialize()$, but it require some computating from the cpu.

\chapter{Display the organ using OpenGL}

To use this shader program without lighting, we have to define the projection matrix, the modelview matrix and a flag to avoid using lighting:

\begin{lstlisting}
        // Handle for shader variables
    	GLuint handle(0);

    	handle = glGetUniformLocation(shader_id, "g_projection_matrix");
        glUniformMatrix4fv(handle, 1, GL_FALSE, g_current_projection_matrix.get());
        checkOpenGLErrorStatus(__FILE__, __FUNCTION__, __LINE__);

        handle = glGetUniformLocation(shader_id, "g_modelview_matrix");
        glUniformMatrix4fv(handle, 1, GL_FALSE, g_current_modelview_matrix.get());
        checkOpenGLErrorStatus(__FILE__, __FUNCTION__, __LINE__);

        //Don't use lighting
        GLint lighting;
        lighting = 0;
        handle = glGetUniformLocation(shader_id,"g_use_lighting");
        glUniform1iv(handle, 1, &lighting);
        checkOpenGLErrorStatus(__FILE__, __FUNCTION__, __LINE__);
\end{lstlisting}

Then we use the function of the lung mesh to define the others inputs:

\begin{lstlisting}
        m_lung_mesh.defineDisplayShaderInput(shader_id);
\end{lstlisting}

Finally, we can display the mesh:

\begin{lstlisting}
        // Display the current patient
   		m_lung_mesh.display();
\end{lstlisting}

\chapter{result}

The lungs is automatically textured:\\

\includegraphics[scale = 0.5]{img/textured_lungs.png}

\chapter{Annexe}

The class diagram of the anatomical mesh classes:\\

\includegraphics[scale = 0.5]{img/UML.png}

\end{document}