macro(build_fftw3 install_prefix staging_prefix)


# make a custom FFTW3 configuration file

SET (FFTW3_VERSION_STRING 3.3)
SET (FFTW3_VERSION_MAJOR  3.3)
SET (FFTW3_VERSION_MINOR  5)

set (CMAKE_OSX_EXTERNAL_PROJECT_ARGS)
if(APPLE)
    list(APPEND CMAKE_OSX_EXTERNAL_PROJECT_ARGS
        -DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}
        -DCMAKE_OSX_ARCHITECTURES=${CMAKE_OSX_ARCHITECTURES}
        -DCMAKE_OSX_SYSROOT=${CMAKE_OSX_SYSROOT}
        -DMACOSX_RPATH:BOOL=ON
        -DCMAKE_OSX_DEPLOYMENT_TARGET=${CMAKE_OSX_DEPLOYMENT_TARGET}
    )
endif()

SET (FFTW3_INSTALL_DIR ${staging_prefix}/${install_prefix}-install)
SET (FFTW3_SOURCE_DIR ${staging_prefix}/${install_prefix}-source)
SET (FFTW3_BINARY_DIR ${staging_prefix}/${install_prefix}-build)

ExternalProject_Add(fftw3
    URL  "ftp://ftp.fftw.org/pub/fftw/fftw-3.3.5.tar.gz"
    URL_MD5 "6cc08a3b9c7ee06fdd5b9eb02e06f569"
    SOURCE_DIR  ${FFTW3_SOURCE_DIR}
    BINARY_DIR  ${FFTW3_BINARY_DIR}
    INSTALL_DIR ${FFTW3_INSTALL_DIR}
    CONFIGURE_COMMAND ${FFTW3_SOURCE_DIR}/configure --prefix=${FFTW3_INSTALL_DIR}
    BUILD_COMMAND ${MAKE}
    CMAKE_ARGS
      -DCMAKE_C_FLAGS:STRING=${CMAKE_C_FLAGS}
      -DCMAKE_C_COMPILER:FILEPATH=${CMAKE_C_COMPILER}
      -DCMAKE_CXX_FLAGS:STRING=${CMAKE_CXX_FLAGS}
      -DCMAKE_CXX_COMPILER:FILEPATH=${CMAKE_CXX_COMPILER}
      -DCMAKE_EXE_LINKER_FLAGS:STRING=${LINKER_FLAGS}
      -DBUILD_SHARED_LIBS:BOOL=OFF
      -DCMAKE_TOOLCHAIN_FILE:FILEPATH=${CMAKE_TOOLCHAIN_FILE}
      -DCMAKE_OSX_ARCHITECTURES=${CMAKE_OSX_ARCHITECTURES}
      -DCMAKE_OSX_SYSROOT=${CMAKE_OSX_SYSROOT}
      -DMACOSX_RPATH:BOOL=ON
      -DCMAKE_OSX_DEPLOYMENT_TARGET=${CMAKE_OSX_DEPLOYMENT_TARGET}
)

SET (FFTW3_INCLUDE_DIR  ${FFTW3_INSTALL_DIR}/include  CACHE PATH "Where FFTW3's headers are."   FORCE)
SET (FFTW3_INCLUDE_DIRS ${FFTW3_INSTALL_DIR}/include  CACHE PATH "Where FFTW3's headers are."   FORCE)
SET (FFTW3_LIBRARY_DIR  ${FFTW3_INSTALL_DIR}/lib      CACHE PATH "Where FFTW3's libraries are."   FORCE)

IF (UNIX)

        SET (FFTW3_LIBRARY
            ${FFTW3_INSTALL_DIR}/lib/libfftw3.a
            CACHE FILEPATH "FFTW3's libraries." FORCE
        )

ENDIF (UNIX)

set (FFTW3_LIBRARIES    ${FFTW3_LIBRARY}     CACHE FILEPATH "FFTW3's libraries." FORCE)
set (FFTW3_INCLUDE_PATH ${FFTW3_INCLUDE_DIR} CACHE PATH "Where FFTW3's headers are."   FORCE)

SET(FFTW3_FOUND ON)


# copy libraries into install tree
install(DIRECTORY ${FFTW3_INSTALL_DIR}/bin/     DESTINATION ${INSTALL_DIR}/third_party/bin     COMPONENT Development FILES_MATCHING PATTERN "*.*")
install(DIRECTORY ${FFTW3_INSTALL_DIR}/include/ DESTINATION ${INSTALL_DIR}/third_party/include COMPONENT Development FILES_MATCHING PATTERN "*.*")
install(DIRECTORY ${FFTW3_INSTALL_DIR}/lib/     DESTINATION ${INSTALL_DIR}/third_party/lib     COMPONENT Development FILES_MATCHING PATTERN "*.*")
install(DIRECTORY ${FFTW3_INSTALL_DIR}/share/   DESTINATION ${INSTALL_DIR}/third_party/share   COMPONENT Development FILES_MATCHING PATTERN "*.*")

endmacro(build_fftw3)
